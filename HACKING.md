# Testing UGMM locally

I recommend testing UGMM within a VM or container rather than directly
on the development system. This avoids screwing up your local system,
and ensures the test environment is closer to the deployment
environment.

The instructions below use LXD, but other systems should also work.


## Setting up a container

Set up a Debian 13 container with the ugmm source mounted under
`/usr/share/plug-ugmm` by running the following from a ugmm checkout:

```sh
lxc launch images:debian/13 ugmm-test
lxc config device add ugmm-test plug-ugmm disk source=$(pwd) path=/usr/share/plug-ugmm
```

We can then launch a root shell within the container, where our
checkout will be visible live:

```sh
lxc shell ugmm-test
ls /usr/share/plug-ugmm
```

## Configuring services

From the container root shell, set up the LDAP server:

```sh
cd /usr/share/plug-ugmm
./ci/setup-slapd.sh
```

Set up nginx, configured to serve UGMM:
```sh
apt-get install -y nginx php-fpm smarty4 php-net-ldap2
cp ./ci/ugmm-nginx.conf /etc/nginx/sites-available/
ln -s ../sites-available/ugmm-nginx.conf /etc/nginx/sites-enabled/
systemctl restart nginx.service
```

Create configuration and cache directories needed by ugmm:

```
mkdir -p /etc/private
cp /usr/share/plug-ugmm/lib/PLUG/ldapconnection.inc.php.example /etc/private/ldapconnection.inc.php
mkdir -p /var/cache/plug-ugmm/templates_c
chown www-data:www-data /var/cache/plug-ugmm/templates_c
```

Set up the fake sendmail script:

```sh
cp ./ci/fake-sendmail.sh /usr/sbin/sendmail
```

## Manual Testing

You should now be able to visit ugmm at
`http://$container_ip:8000/`. Changes made to the PHP code on the host
should be immediately visible in your browser.

The sample data comes with a couple of sample users:

* A regular user `bobtest` with password `test432bob`
* A committee member `chair` with password `chairpass`

Any email generated by the app will end up in `/tmp/ugmm-mbox`.


## Running the tests

UGMM comes with a test suite, which can be run from within the
container. First install the testing dependencies from the container
shell:

```sh
apt-get install -y phpunit php-symfony-browser-kit php-symfony-css-selector php-symfony-http-client php-symfony-mime
```

Once the dependencies are installed, the tests can be run with:

```sh
cd /usr/share/plug-ugmm
phpunit --testdox tests
```

These are end-to-end integration tests running against the UGMM
instance running in nginx. So if you've messed around with the LDAP
sample data too much, they may not pass.

You can easily reset the LDAP database with:

```sh
apt-get purge slapd
./ci/setup-slapd.sh
```
